#!/bin/bash -ue

# OrientDB init script

# You have to SET the OrientDB installation directory here
ORIENTDB_DIR="${OPENSHIFT_ORIENTDB_DIR}/versions/${OPENSHIFT_ORIENTDB_VERSION}"
ORIENTDB_USER="jelastic"

function usage {
  echo "Usage: `basename $0`: <start|stop|status|restart>"
  exit 1
}

function start {
  status
  if [ $PID -gt 0 ]; then
    echo "OrientDB server daemon was already started. PID: $PID"
    return $PID
  fi

  echo "Starting OrientDB server daemon..."
  pushd $ORIENTDB_DIR/bin 1> /dev/null
    local log_file=${OPENSHIFT_ORIENTDB_DB_LOG_DIR}/orientdb.log
    local err_file=${OPENSHIFT_ORIENTDB_DB_LOG_DIR}/orientdb.err
    /usr/bin/nohup ./server.sh 1>$log_file 2>$err_file &
  popd 1> /dev/null
}

function stop {
  status
  if [ $PID -eq 0 ]; then
    echo "OrientDB server daemon is already not running"
    return 0
  fi
  echo "Stopping OrientDB server daemon..."
  cd $ORIENTDB_DIR/bin && /usr/bin/nohup ./shutdown.sh 1>>${OPENSHIFT_ORIENTDB_LOG_DIR}/orientdb.log 2>>${OPENSHIFT_ORIENTDB_LOG_DIR}/orientdb.err 
}

function status {
  PID=`ps -ef | grep 'orientdb.www.path' | grep java | grep -v grep | awk '{print $2}'`
  if [ "x$PID" = "x" ]; then
    PID=0
  fi

  # if PID is greater than 0 then OrientDB is running, else it is not
  return $PID
}

case "$1" in
  start)
    start
    exit 0
  ;;

  stop)
    stop
    exit 0
  ;;

  status)
    status
    if [ $PID -gt 0 ]; then
      echo "OrientDB server daemon is running with PID: $PID"
    else
      echo "OrientDB server daemon is NOT running"
    fi
    exit $PID
  ;;

  restart)
    stop
    start
    exit 0
  ;;

  *)
    usage
  ;;
esac
